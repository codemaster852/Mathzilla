<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathZilla - Conquer Math from Zero to Fluency</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :lang(en) { font-family: 'Inter', sans-serif; }
        :lang(ar) { font-family: 'Cairo', sans-serif; }
        body { scroll-behavior: smooth; }
        .chat-bubble-user { background-color: #4f46e5; color: white; }
        .chat-bubble-ai { background-color: #e5e7eb; color: #1f2937; }
        .lds-ellipsis { display: inline-block; position: relative; width: 80px; height: 20px; }
        .lds-ellipsis div { position: absolute; top: 5px; width: 13px; height: 13px; border-radius: 50%; background: #4f46e5; animation-timing-function: cubic-bezier(0, 1, 1, 0); }
        .lds-ellipsis div:nth-child(1) { left: 8px; animation: lds-ellipsis1 0.6s infinite; }
        .lds-ellipsis div:nth-child(2) { left: 8px; animation: lds-ellipsis2 0.6s infinite; }
        .lds-ellipsis div:nth-child(3) { left: 32px; animation: lds-ellipsis2 0.6s infinite; }
        .lds-ellipsis div:nth-child(4) { left: 56px; animation: lds-ellipsis3 0.6s infinite; }
        @keyframes lds-ellipsis1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes lds-ellipsis3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }
        @keyframes lds-ellipsis2 { 0% { transform: translate(0, 0); } 100% { transform: translate(24px, 0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Modals (Auth, Admin Login) -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <div class="flex justify-between items-center mb-6"><h2 id="auth-title" class="text-2xl font-bold" data-translate="auth_login_title">Login</h2><button id="close-modal-button" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden"></div>
            <form id="auth-form"><div class="mb-4"><label for="email" class="block text-sm font-medium" data-translate="auth_email">Email</label><input type="email" id="email" required class="mt-1 block w-full p-2 border rounded-md"></div><div class="mb-6"><label for="password" class="block text-sm font-medium" data-translate="auth_password">Password</label><input type="password" id="password" required class="mt-1 block w-full p-2 border rounded-md"></div><button type="submit" id="auth-submit-button" class="w-full bg-indigo-600 text-white py-2 rounded-md" data-translate="auth_login_btn">Login</button></form>
            <p class="text-center text-sm mt-4"><span id="auth-toggle-text" data-translate="auth_no_account">No account?</span> <button id="auth-toggle-button" class="font-medium text-indigo-600" data-translate="auth_signup_link">Sign up</button></p>
        </div>
    </div>
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Admin Access</h2><div id="admin-login-error" class="bg-red-100 text-red-700 p-3 rounded mb-4 hidden"></div>
            <form id="admin-login-form"><div class="mb-4"><label for="admin-username" class="block">Username</label><input type="text" id="admin-username" required class="mt-1 w-full p-2 border rounded"></div><div class="mb-6"><label for="admin-password" class="block">Password</label><input type="password" id="admin-password" required class="mt-1 w-full p-2 border rounded"></div><button type="submit" class="w-full bg-gray-800 text-white py-2 rounded">Login</button><button type="button" id="close-admin-login" class="w-full bg-gray-200 mt-2 py-2 rounded">Cancel</button></form>
        </div>
    </div>

    <!-- App Wrapper -->
    <div id="app-container">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="text-3xl font-bold text-indigo-600">MathZilla</a>
                <div class="flex items-center space-x-4">
                    <select id="language-switcher" class="border-gray-300 rounded-md"><option value="en">English</option><option value="ar">العربية</option></select>
                    <div id="auth-buttons"><button id="login-button" class="hidden md:inline-block" data-translate="nav_login">Login</button><button id="signup-button" class="bg-indigo-600 text-white px-4 py-2 rounded-md" data-translate="nav_signup">Sign Up</button></div>
                    <div id="user-session" class="hidden"><span id="user-greeting" class="hidden sm:inline"></span><button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-md" data-translate="nav_logout">Logout</button></div>
                </div>
            </nav>
        </header>
        <main id="main-content" class="hidden"></main>
        <div id="public-view">
            <section class="bg-indigo-600 text-white"><div class="container mx-auto px-6 py-20 text-center"><h1 class="text-5xl font-extrabold" data-translate="hero_title">Welcome to MathZilla</h1><p class="text-xl my-4" data-translate="hero_subtitle">Your journey to mastering mathematics.</p><button id="get-started-button" class="bg-white text-indigo-600 font-bold py-3 px-8 rounded-full" data-translate="hero_cta">Start Your Adventure</button></div></section>
            <footer class="bg-gray-800 text-white py-10"><div class="container mx-auto px-6 text-center"><p>&copy; 2025 MathZilla. <span id="admin-login-trigger" class="cursor-pointer opacity-50">Admin</span></p></div></footer>
        </div>
    </div>

    <!-- Templates -->
    <template id="level-selection-template">
        <section class="py-12 bg-gray-100"><div class="container mx-auto px-6 text-center"><h1 class="text-3xl md:text-4xl font-bold" data-translate="level_select_title">Chart Your Journey</h1><p class="text-lg text-gray-600 my-4" data-translate="level_select_subtitle">Choose a path or take a test.</p><div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-8"><div id="choose-level-path" class="bg-white p-8 rounded-lg shadow-lg border-2 hover:border-indigo-500 cursor-pointer"><h2 class="text-2xl font-bold" data-translate="level_select_choose">Choose Level</h2><p data-translate="level_select_choose_desc">Pick a level and jump in.</p></div><div id="take-test-path" class="bg-white p-8 rounded-lg shadow-lg border-2 hover:border-indigo-500 cursor-pointer"><h2 class="text-2xl font-bold" data-translate="level_select_test">Placement Test</h2><p data-translate="level_select_test_desc">Find the right starting point.</p></div></div></div></section>
    </template>

    <template id="level-cards-template">
         <section class="py-12 bg-gray-100"><div class="container mx-auto px-6"><h2 class="text-4xl font-bold text-center mb-12" data-translate="levels_title">Learning Journey</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="level-card" data-level="zero"><h3 data-translate="level_zero">Zilla Zero</h3><p data-translate="level_zero_desc">Number sense.</p></div>
            <div class="level-card" data-level="start"><h3 data-translate="level_start">Zilla Start</h3><p data-translate="level_start_desc">Core operations.</p></div>
            <div class="level-card" data-level="logic"><h3 data-translate="level_logic">Zilla Logic</h3><p data-translate="level_logic_desc">Fractions, decimals.</p></div>
            <div class="level-card" data-level="brain"><h3 data-translate="level_brain">Zilla Brain</h3><p data-translate="level_brain_desc">Algebra.</p></div>
            <div class="level-card" data-level="pro"><h3 data-translate="level_pro">Zilla Pro</h3><p data-translate="level_pro_desc">Geometry.</p></div>
            <div class="level-card" data-level="master"><h3 data-translate="level_master">Zilla Master</h3><p data-translate="level_master_desc">Calculus.</p></div>
            <div class="level-card" data-level="guru"><h3 data-translate="level_guru">Zilla Guru</h3><p data-translate="level_guru_desc">Olympiad prep.</p></div>
         </div></div></section>
    </template>
    
    <template id="dashboard-template">
        <div class="flex flex-col md:flex-row min-h-screen">
            <!-- Sidebar -->
            <aside class="w-full md:w-64 bg-white shadow-lg p-4">
                <nav id="dashboard-nav" class="space-y-2">
                    <a href="#" class="nav-item active" data-target="main-dashboard-view" data-translate="nav_dashboard">Dashboard</a>
                    <a href="#" class="nav-item" data-target="progress-view" data-translate="nav_progress">Progress Tracker</a>
                    <a href="#" class="nav-item" data-target="missions-view" data-translate="nav_missions">Missions</a>
                    <a href="#" class="nav-item" data-target="arcade-view" data-translate="nav_arcade">Math Arcade</a>
                    <a href="#" class="nav-item" data-target="tools-view" data-translate="nav_tools">Visual Tools</a>
                    <a href="#" class="nav-item" data-target="community-view" data-translate="nav_community">Community</a>
                </nav>
            </aside>
            <!-- Main Content Area -->
            <main id="dashboard-content" class="flex-1 p-8 bg-gray-100"></main>
        </div>
    </template>

    <!-- Dashboard Views -->
    <template id="main-dashboard-view-template">
        <h1 class="text-3xl font-bold mb-2" data-translate="dashboard_welcome">Welcome!</h1>
        <p id="dashboard-level-display" class="text-lg text-indigo-600 font-semibold mb-8"></p>
        <div id="lessons-container" class="space-y-6 mb-12"></div>
        <div id="tutor" class="mt-12"></div>
    </template>

    <template id="progress-view-template">
        <h1 class="text-3xl font-bold mb-6" data-translate="progress_title">Your Progress</h1>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <canvas id="progress-chart"></canvas>
        </div>
    </template>
    
    <template id="missions-view-template"><h1 class="text-3xl font-bold" data-translate="missions_title">Daily Missions</h1><p class="mt-4">Coming soon...</p></template>
    <template id="arcade-view-template"><h1 class="text-3xl font-bold" data-translate="arcade_title">Math Arcade</h1><p class="mt-4">Coming soon...</p></template>
    <template id="tools-view-template"><h1 class="text-3xl font-bold" data-translate="tools_title">Visual Tools</h1><p class="mt-4">Coming soon...</p></template>
    <template id="community-view-template"><h1 class="text-3xl font-bold" data-translate="community_title">Community Hub</h1><p class="mt-4">Coming soon...</p></template>

    <template id="tutor-template">
        <h2 class="text-4xl font-bold text-center mb-4" data-translate="tutor_title">Ask MathZilla</h2>
        <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-2xl">
            <div id="chat-window" class="p-6 h-96 overflow-y-auto space-y-4"></div>
            <div class="p-4 bg-gray-100 rounded-b-lg">
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="eli5-toggle" class="h-4 w-4 text-indigo-600 rounded">
                    <label for="eli5-toggle" class="ml-2 text-sm" data-translate="tutor_eli5">Explain Like I'm 5</label>
                </div>
                <div class="flex items-center">
                    <input type="text" id="chat-input" data-translate="tutor_placeholder" placeholder="Type..." class="w-full p-2 border rounded-s-md">
                    <button id="send-button" class="bg-indigo-600 text-white px-6 py-2 rounded-e-md" data-translate="tutor_send_btn">Send</button>
                </div>
            </div>
        </div>
    </template>

    <template id="admin-panel-template">
        <div class="p-8 bg-gray-800 text-white min-h-screen">
            <div class="flex justify-between items-center mb-8"><h1 class="text-4xl font-bold">Admin Panel</h1><button id="admin-logout-button" class="bg-red-600 px-4 py-2 rounded">Logout</button></div>
            <div class="bg-gray-700 p-6 rounded-lg mb-8">
                <h2 id="lesson-form-title" class="text-2xl font-bold mb-4">Add Lesson</h2>
                <form id="lesson-form">
                    <input type="hidden" id="lesson-id">
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="lesson-title" placeholder="Title" required class="p-2 rounded bg-gray-600">
                        <select id="lesson-level" required class="p-2 rounded bg-gray-600">
                            <option value="zero">Zilla Zero</option><option value="start">Zilla Start</option><option value="logic">Zilla Logic</option>
                            <option value="brain">Zilla Brain</option><option value="pro">Zilla Pro</option><option value="master">Zilla Master</option><option value="guru">Zilla Guru</option>
                        </select>
                        <input type="text" id="lesson-video-url" placeholder="YouTube ID" class="p-2 rounded bg-gray-600">
                    </div>
                    <textarea id="lesson-content" placeholder="Content (HTML)" rows="5" required class="w-full p-2 rounded bg-gray-600 mb-4"></textarea>
                    <div class="flex gap-4"><button type="submit" class="bg-indigo-600 px-6 py-2 rounded">Save</button><button type="button" id="cancel-edit-button" class="bg-gray-500 px-4 py-2 rounded hidden">Cancel</button></div>
                </form>
            </div>
            <div id="lessons-list" class="bg-gray-700 p-6 rounded-lg"><h2 class="text-2xl font-bold mb-4">Lessons</h2><div id="lessons-list-content" class="space-y-4"></div></div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, remove, push, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9Bm7dKDSsxS5jKYDc8er3J7Vopjq7MHU",
            authDomain: "mathzilla-30d13.firebaseapp.com",
            projectId: "mathzilla-30d13",
            storageBucket: "mathzilla-30d13.appspot.com",
            messagingSenderId: "280990702319",
            appId: "1:280990702319:web:478fa49a5f66aa83d3591a",
            databaseURL: "https://mathzilla-30d13-default-rtdb.firebaseio.com/"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const GEMINI_API_KEY = "AIzaSyAKONLfwJCi-zoJxvMIkuhfOVbwc2gXQGQ";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        
        // Translations object with all keys
        const translations = {
            en: {
                nav_login: "Login", nav_signup: "Sign Up", nav_logout: "Logout", nav_dashboard: "Dashboard", nav_progress: "Progress", nav_missions: "Missions", nav_arcade: "Arcade", nav_tools: "Tools", nav_community: "Community",
                hero_title: "Welcome to MathZilla", hero_subtitle: "Your journey to mastering mathematics.", hero_cta: "Start Your Adventure",
                auth_login_title: "Login", auth_signup_title: "Sign Up", auth_email: "Email", auth_password: "Password", auth_login_btn: "Login", auth_signup_btn: "Sign Up", auth_no_account: "No account?", auth_have_account: "Have an account?", auth_signup_link: "Sign up", auth_login_link: "Login",
                level_select_title: "Chart Your Journey", level_select_subtitle: "Choose a path or take a test.", level_select_choose: "Choose Level", level_select_choose_desc: "Pick a level and jump in.", level_select_test: "Placement Test", level_select_test_desc: "Find the right starting point.",
                levels_title: "Learning Journey", level_zero: "Zilla Zero", level_zero_desc: "Number sense.", level_start: "Zilla Start", level_start_desc: "Core operations.", level_logic: "Zilla Logic", level_logic_desc: "Fractions, decimals.", level_brain: "Zilla Brain", level_brain_desc: "Algebra.", level_pro: "Zilla Pro", level_pro_desc: "Geometry.", level_master: "Zilla Master", level_master_desc: "Calculus.", level_guru: "Zilla Guru", level_guru_desc: "Olympiad prep.",
                dashboard_welcome: "Welcome!", progress_title: "Your Progress", missions_title: "Daily Missions", arcade_title: "Math Arcade", tools_title: "Visual Tools", community_title: "Community Hub",
                tutor_title: "Ask MathZilla", tutor_greeting: "Hello! Ask any math question.", tutor_placeholder: "Type...", tutor_send_btn: "Send", tutor_eli5: "Explain Like I'm 5"
            },
            ar: {
                nav_login: "دخول", nav_signup: "حساب جديد", nav_logout: "خروج", nav_dashboard: "الرئيسية", nav_progress: "التقدم", nav_missions: "المهام", nav_arcade: "الألعاب", nav_tools: "الأدوات", nav_community: "المجتمع",
                hero_title: "أهلاً في ماث-زيلا", hero_subtitle: "رحلتك لإتقان الرياضيات.", hero_cta: "ابدأ المغامرة",
                auth_login_title: "تسجيل الدخول", auth_signup_title: "إنشاء حساب", auth_email: "البريد الإلكتروني", auth_password: "كلمة المرور", auth_login_btn: "دخول", auth_signup_btn: "إنشاء", auth_no_account: "لا حساب لديك؟", auth_have_account: "لديك حساب؟", auth_signup_link: "أنشئ حساب", auth_login_link: "سجل دخول",
                level_select_title: "ارسم رحلتك", level_select_subtitle: "اختر مسارًا أو قم بإجراء اختبار.", level_select_choose: "اختر المستوى", level_select_choose_desc: "اختر مستوى وابدأ.", level_select_test: "اختبار تحديد المستوى", level_select_test_desc: "لنجد لك نقطة البداية.",
                levels_title: "الرحلة التعليمية", level_zero: "زيلا صفر", level_zero_desc: "أساسيات الأعداد.", level_start: "زيلا البداية", level_start_desc: "العمليات الأساسية.", level_logic: "زيلا المنطق", level_logic_desc: "الكسور والأعداد العشرية.", level_brain: "زيلا العقل", level_brain_desc: "الجبر.", level_pro: "زيلا المحترف", level_pro_desc: "الهندسة.", level_master: "زيلا الخبير", level_master_desc: "التفاضل والتكامل.", level_guru: "زيلا المعلم", level_guru_desc: "تحضير الأولمبياد.",
                dashboard_welcome: "أهلاً بك!", progress_title: "مستوى تقدمك", missions_title: "المهام اليومية", arcade_title: "ركن الألعاب", tools_title: "الأدوات المرئية", community_title: "ساحة المجتمع",
                tutor_title: "اسأل ماث-زيلا", tutor_greeting: "مرحباً! اسأل أي سؤال.", tutor_placeholder: "اكتب...", tutor_send_btn: "إرسال", tutor_eli5: "اشرح كأنني طفل"
            }
        };

        // --- Core App Logic ---
        const updateLanguage = (lang) => { /* ... same as before ... */ };
        const renderView = (container, templateId, eventHandlers) => {
            container.innerHTML = document.getElementById(templateId).innerHTML;
            updateLanguage(document.documentElement.lang);
            if (eventHandlers) eventHandlers();
        };

        // --- User Flow & Dashboard ---
        const showDashboard = (level) => {
            renderView(document.getElementById('main-content'), 'dashboard-template', () => {
                const dashboardContent = document.getElementById('dashboard-content');
                
                const renderDashboardView = (viewId) => {
                    renderView(dashboardContent, `${viewId}-template`, () => {
                        if (viewId === 'main-dashboard-view') {
                            const levelName = translations[document.documentElement.lang]['level_' + level] || level;
                            document.getElementById('dashboard-level-display').textContent = `Current Level: ${levelName}`;
                            document.getElementById('tutor').innerHTML = document.getElementById('tutor-template').innerHTML;
                            updateLanguage(document.documentElement.lang);
                            initializeChat();
                            loadLessonsForUser(level);
                        } else if (viewId === 'progress-view') {
                            initializeProgressChart();
                        }
                    });
                };
                
                renderDashboardView('main-dashboard-view'); // Initial view

                document.getElementById('dashboard-nav').addEventListener('click', (e) => {
                    if (e.target.classList.contains('nav-item')) {
                        e.preventDefault();
                        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                        e.target.classList.add('active');
                        renderDashboardView(e.target.dataset.target);
                    }
                });
            });
        };
        
        const setupLevelSelection = () => { /* ... same as before, uses main-content ... */ };

        onAuthStateChanged(auth, async user => { /* ... same as before ... */ });

        // --- New Feature Initializers ---
        const initializeProgressChart = () => {
            const ctx = document.getElementById('progress-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Topics Mastered',
                        data: [5, 9, 12, 17, 23, 28],
                        borderColor: '#4f46e5',
                        tension: 0.1
                    }]
                }
            });
        };
        
        const initializeChat = () => {
             const chatWindow = document.getElementById('chat-window');
             const chatInput = document.getElementById('chat-input');
             const sendButton = document.getElementById('send-button');
             const eli5Toggle = document.getElementById('eli5-toggle');

             const sendMessage = async () => {
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                
                let prompt = `Act as a friendly math tutor. Explain concepts clearly. User question: "${userMessage}"`;
                if(eli5Toggle.checked) {
                    prompt = `Explain the following math concept to a 5-year-old in a simple, fun, and encouraging way. Use simple analogies. Concept: "${userMessage}"`;
                }
                // ... rest of the send message logic
             };
             // ... event listeners
        };

        // --- Admin Panel, Lesson Loading, etc. ---
        // All other functions (showAdminPanel, loadLessonsForAdmin, loadLessonsForUser, etc.)
        // remain largely the same, just ensure they target the correct containers.
        // The admin panel's lesson level dropdown is already updated in the template.

        // --- Initializers ---
        updateLanguage('en');
        // All event listeners for auth modals, etc. remain the same.

    </script>
</body>
</html>
